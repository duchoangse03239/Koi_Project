@using KoiManagement.DAL
@using KoiManagement.Models

@{
    ViewBag.Title = "Hỏi đáp chi tiết";
    Layout = "~/Views/Layout/KoiLayout.cshtml";
    Question questiondetail = ViewBag.questionDetail;
    List<Answer> listAnswer = ViewBag.answerDetail;
    QuestionAnswerDAO QaDao = new QuestionAnswerDAO();
}


    <div class="container">
    <div style="margin-top: 20px;" class="row">
        <div class="col-md-12 column  top-msg breadcrumb">
            <span id="breadcrumb">
                <a style="text-decoration: none;" href="#"><i class="fa fa-home"></i></a>
                <a style="text-decoration: none;" href="#">some category</a>
                <a style="text-decoration: none;" href="#">some topic</a>
            </span>
        </div>
    </div>
    <div class="row" style="background-color: #fafafa;">
        <div class="col-md-12" style="background-color: #000055;">
            <div class="col-md-10">
                <h4 style="color: white;">@questiondetail.Title</h4>
            </div>
            <div class="col-md-2">
                <h5 style="color: white; float: right;">@questiondetail.Datetime</h5>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <img style="margin: 15px; height: 100px; width: auto" src="~/Content/Image/Member/@questiondetail.Member.Image">
            </div>
            <div class="col-md-10" style="padding-top: 15px;">
                <a style="color: #397ab2;" href="@Url.Action("Profile/" + @questiondetail.Member.MemberID, "Account")">@questiondetail.Member.UserName</a>
                <h5>@questiondetail.Member.Phone</h5>
            </div>
        </div>
        <hr>
        <div>
            @Html.Raw(@questiondetail.Content)
        </div>
        <div class="col-md-12" style="background-color: #f5f5f5; margin-top: 10px;">
            <div class="col-md-2">
                <label style="float: right;">Đánh giá: @QaDao.getTotalRateQuestion(questiondetail.QuestionID)</label>
            </div>
            <div class="col-md-2">
                <input type="number" name="your_awesome_parameter" id="rating-default" class="rating" value="@QaDao.getRateQuestion(questiondetail.QuestionID)" />
            </div>
            <div class="col-md-1">
                <a href="">Trả lời</a>
            </div>
            <div class="col-md-2">
                <a href="">Báo cáo</a>
            </div>
        </div>
    </div>
    @foreach (var item in listAnswer)
    {
        <div class="row" style="background-color: #fafafa; margin-top: 15px;">
            <div class="col-md-12" style="background-color: #000055;">

                <div class="col-md-2 col-md-offset-10">
                    <h5 style="color: white; float: right;">@item.Datetime</h5>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <img style="margin: 15px; height: 100px; width: auto" src="~/Content/Image/Member/@item.Member.Image">
                </div>
                <div class="col-md-10" style="padding-top: 15px;">
                    <a style="color: #397ab2;" href="">@item.Member.UserName</a>
                    <h5>@item.Member.Phone</h5>
                </div>
            </div>
            <hr>
            <div>
                @Html.Raw(@item.Content);
            </div>
            <div class="col-md-12" style="background-color: #f5f5f5;">
                <div class="col-md-2">
                    <label style="float: right;">Đánh giá:@QaDao.getTotalRateAnswer(item.AnswerID)</label>
                </div>
                <div class="col-md-2">
                    <input type="number" name="your_awesome_parameter" id="rating-default" class="rating" value="@QaDao.getRateAnswer(item.AnswerID)" />
                </div>
                <div class="col-md-1">
                    <a href="">Trả lời</a>
                </div>
                <div class="col-md-2">
                    <a href="">Báo cáo</a>
                </div>
            </div>
        </div>
    }
    <div class="row" style="background-color: #fafafa; margin-top: 15px;">
        <div class="col-md-12" style="background-color: #000055;">
            <h4 style="color: white;">Trả lời bài viết</h4>
        </div>
        <div class="col-md-12">
            <div>
                <p style="color: red; margin-top: 10px;">Chú ý: Bài viết sẽ bị xóa nếu:</p>
                <p style="color: red;">1. Tiêu đề và nội dung nhập tiếng việt không dấu.</p>
                <p style="color: red;">2. Sử dụng lời lẽ thô tục, vi phạm các quy định của nhà nước.</p>
            </div>
            <hr>
        </div>
        <div class="col-md-12">
            <textarea type="text" class="form-control" placeholder="" id="content" name="content"></textarea>
            <label id="lblmessage_content_fail" class="label-error"></label>
        </div>
        <div class="col-md-12">
            <div style="float: right; margin-top: 15px; margin-bottom: 15px;">
                <a class="btn btn-primary" id="btnCreateAnswer" role="button">Gửi trả lời</a>
            </div>

        </div>
    </div>
</div>


<script type="text/javascript">

    $(document).ready(function() {
        $(function() {
            $("#content").focus();
        });
    });

    $(document).keypress(function(event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == "13") {
            if (Validate()) {
                CreateAnswer();
            } else {
                return false;
            }
        }
    });


    $("#btnCreateAnswer").click(function() {
        if (Validate()) {
            CreateAnswer();
        } else {

            return false;
        }
    });

    function Validate() {

        var content = $('#content').val();
        if (content != null) {
            if (content.length < 6) {
                $('#lblmessage_content_fail').text("Nội dung không được nhỏ hơn 6 ký tự");
                $('#content').focus();
                return false;
            }
        } else {
            $('#lblmessage_content_fail').text("Nội dung không được để trống");
            $('#content').focus();
            return false;
        }
        return true;
    }

    function CreateAnswer() {
        var fileData = new FormData();
        // Adding one more key to FormData object
        fileData.append('qID', @questiondetail.QuestionID);
        var content = $('#content').val();
        fileData.append('content', content);

        $.ajax({
            type: "POST",
            url: "@Url.Action("CreateAnswer")",
            contentType: false, // Not to set any content header
            processData: false,
            data: fileData,
            dataType: "Json",
            success: function(res) {
                switch (res.Status) {
                case 2:
                    break;
                case 3:
                    break;
                case 4:
                    break;
                case 1:
                    alert(res.Message);
                    window.location.href = res.RedirectTo;
                    break;
                case 0:
                    window.location.href = res.RedirectTo;
                    break;
                }
            }
        });
    }


    $(document).ready(function() {
        if (window.File && window.FileList && window.FileReader) {
            $("#files").on("change", function(e) {
                var files = e.target.files,
                    filesLength = files.length;
                for (var i = 0; i < filesLength; i++) {
                    var f = files[i]
                    var fileReader = new FileReader();
                    fileReader.onload = (function(e) {
                        var file = e.target;
                        $("<span class=\"pip\">" +
                            "<img class=\"imageThumb\" src=\"" + e.target.result + "\" title=\"" + file.name + "\"/>" +
                            "<br/><span class=\"remove\">X</span>" +
                            "</span>").insertAfter("#files");
                        $(".remove").click(function() {
                            $(this).parent(".pip").remove();
                        });
                    });
                    fileReader.readAsDataURL(f);
                }
            });
        } else {
            alert("Your browser doesn't support to File API")
        }
    });
</script>

    <script type="text/javascript">
    tinymce.init({
        selector: "textarea",
        width: '100%',
        language: 'vi_VN',
        height: 400,
        statusbar: false,
        menubar: false,

        setup: function (ed) {
            ed.on('init', function () {
                this.getDoc().body.style.fontSize = '14px';
                this.getDoc().body.style.fontFamily = '"Helvetica Neue", Helvetica, Arial, sans-serif';
            });
        },

        paste_data_images: true,

        plugins: [
            "advlist autolink lists link base64_image charmap hr anchor pagebreak",
            "searchreplace wordcount visualblocks visualchars code",
            "insertdatetime media nonbreaking save table contextmenu directionality",
            "emoticons textcolor colorpicker textpattern "
        ],
        toolbar: "undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link base64_image media | forecolor backcolor"
    });

    // Prevent bootstrap dialog from blocking focusin
    $(document).on('focusin', function (e) {
        if ($(e.target).closest(".mce-window").length) {
            e.stopImmediatePropagation();
        }
    });
    </script>
