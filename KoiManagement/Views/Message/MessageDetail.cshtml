@using System.Diagnostics
@using KoiManagement.Common
@using KoiManagement.DAL
@using KoiManagement.Models
@using Message = KoiManagement.Models.Message
@{
    ViewBag.Title = "Tin nhắn";
    Layout = "~/Views/Layout/KoiLayout.cshtml";
    List<Message> listMe = ViewBag.meDetail;
    MemberDAO mem = new MemberDAO();
    var Member = mem.GetMemberbyID(int.Parse(Session[SessionAccount.SessionUserId].ToString()));
    var tomember = 0;
        var frommember=0;
    Message Owner = ViewBag.Ownerid;

}

<div class="section site-main">
    <div class="container">
        <div class="row">


            @{if (Owner.MemberID.HasValue)
                {
                    if (Session[SessionAccount.SessionUserId].ToString().Equals(Owner.MemberID.Value.ToString()))
                    {
                        tomember = Owner.SenderID.Value;
                        frommember = Owner.MemberID.Value;
                    }
                    else
                    {
                        tomember = Owner.MemberID.Value;
                        frommember = Owner.SenderID.Value;
                    }
                }}
            <div class="col-md-10 col-md-offset-1" style="padding: 20px; border: 1px solid #d9d9d9; font-size: 14px;">
                <div>
                    <div class="col-md-12" style="overflow: auto; height: 250px;">
                        <div class="row">
                            @if (Owner.SenderID != null)
                            {
                                <div class="col-md-3">
                                    <a href="@Url.Action("Profile/"+ @Owner.MemberID, "Account")"><b>@Owner.Member1.Name:</b></a>
                                </div>
                            }
                            <div class="col-md-5">
                                <span>@Owner.Content</span>
                            </div>
                            <div class="col-md-4">
                                <span style="float: right;">@Owner.Datetime.ToString("MM/dd/yyyy HH:mm:ss")</span>
                            </div>
                        </div>



                        @for (int i = 0; i < listMe.Count; i++)
                        {
                            <div class="row">
                                @if (listMe.ElementAt(i).MemberID != null)
                                {
                                    <div class="col-md-3">
                                        <a href="@Url.Action("Profile/"+ @listMe.ElementAt(i).Member.MemberID, "Account")"><b>@listMe.ElementAt(i).Member.Name:</b></a>
                                    </div>
                                }
                                else if (listMe.ElementAt(i).SenderID != null)
                                {
                                    <div class="col-md-3">
                                        <a href="@Url.Action("Profile/"+ @listMe.ElementAt(i).Member1.MemberID, "Account")"><b>@listMe.ElementAt(i).Member1.Name:</b></a>
                                    </div>
                                }
                                <div class="col-md-5">
                                    <span>@listMe.ElementAt(i).Content</span>
                                </div>
                                <div class="col-md-4">
                                    <span style="float: right;">@listMe.ElementAt(i).Datetime.ToString("MM/dd/yyyy HH:mm:ss")</span>
                                </div>
                            </div>
                        }
                        <div class="row" id="MessageMore">
                        </div>
                    </div>
                    <div class="col-md-12">
                        <textarea style="width: 100%;" id="Comment" rows="3" placeholder="Nhập nội dung tin nhắn"></textarea>
                    </div>
                    <br>
                    <div class="col-md-12">
                        <button style="float: right; margin-top:10px;" id="btnSendMe"  class="btn btn-primary">Gửi</button>
                    </div>
                    <input type="hidden" name="NameMember" id="NameMember" value="@Member.Name">
                </div>
            </div>
        </div>
    </div>
</div>
    <!--Script references. -->
<!--Reference the jQuery library. -->
<script src="/Scripts/jquery-2.0.3.min.js"></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.1.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript"> </script>
<script type="text/javascript">
    $(function() {


        // Declare a proxy to reference the hub.
        var notifications = $.connection.notificationsHub;

        notifications.client.signalConnectionId = function(data) {
            var signalConnectionId = data;
        }
        var $tbl = $('#MessageMore');
        var to =@Session[SessionAccount.SessionUserId].ToString();
        var from= @frommember;
        notifications.client.broadcastNotification = function(userid, name, message) {

            if (userid == to ||from ==to ) {
                // Add the message to the page.
               // $('#Notification').text("");
                $tbl.append(message);
            };
        }


        // Start the connection.
        $.connection.hub.start()
                .done(function() {
                });
    });
</script>


<script>
    $(document)
        .keypress(function(event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if (keycode == "13") {
                if (Validate()) {
                    DisplayListItems();
                } else {
                    return false;
                }
            }
        });

    $("#btnSendMe").click(function () {
        if (Validate()) {
            DisplayListItems();
        } else {

            return false;
        }
    });
    function Validate() {
        return true;
    }

    function DisplayListItems() {
        var comment = $('#Comment').val();
        $('#Comment').val('');
        $('#Comment').focus();
        var name = $('#NameMember').val();

        var currentdate = new Date();
        var datetime = " " +
            currentdate.getDate() +
            "/" +
            (currentdate.getMonth() + 1) +
            "/" +
            currentdate.getFullYear() +
            " " +
            currentdate.getHours() +
            ":" +
            currentdate.getMinutes() +
            ":" +
            currentdate.getSeconds();
        var itemHTML = [
            "<div class='col-md-3'>",
            "<a>", "<b>" + name, "</b>", "</a>",
            "</div>",
            "<div class='col-md-5'>",
            "<span>" + comment + "</span>",
            "</div>",
            "<div class='col-md-4'>",
            "<span style='float: right;'>" + datetime + "</span>",
            "</div>",
        ].join('\n');

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddMessage")",
            datatype: "JSON",
            data: {
                messageid: @ViewBag.messageID,
            content : comment,
            tomember:1
        },
        success: function (res) {
            if (res) {

            }
        }
        });

        // Declare a proxy to reference the hub.
        var notifications = $.connection.notificationsHub;
        // Create a function that the hub can call to broadcast messages.

        $.connection.hub.start()
                               .done(function () {
                                   notifications.server.sendNotification(@tomember, "doi chu", itemHTML);
                               });
    //    $.connection.hub.start()
    //.done(function () {
    //    notifications.server.SendMessage("1", "koi");
    //});

    }
    
    function getStamp() {
        var d = new Date();

        var mm = d.getMilliseconds(), hh = d.getHours(),
            MM = d.getMinutes(), ss = d.getSeconds();

        return (hh < 10 ? "0" : "") + hh + (MM < 10 ? ":0" : ":") + MM + (ss < 10 ? ":0" : ":") + ss + ":" + mm;
    }
</script>